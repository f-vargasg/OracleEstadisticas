DROP TABLE TmpSaldos
/

create table TmpSaldos 
(num_consec	NUMBER(10),
 FEC_MOVIM	DATE,
 cod_moneda_n NUMBER(3),
 des_movim	VARCHAR2(500),
 mto_credito NUMBER(18,2),
 mto_debito  NUMBER(18,2),
 CONSTRAINT PK_TMPSALDOS PRIMARY KEY 
  (
    NUM_CONSEC 
  )
)

/

begin
  INSERT INTO TMPSALDOS  VALUES (1,TO_DATE ('01/05/2020', 'DD/MM/RRRR'),1,'Movimiento 1', 0.00, 2.00); 
 INSERT INTO TMPSALDOS  VALUES (2,TO_DATE ('02/05/2020', 'DD/MM/RRRR'),1,'Movimiento 2', 4.00, 0.00); 
 INSERT INTO TMPSALDOS  VALUES (3,TO_DATE ('03/05/2020', 'DD/MM/RRRR'),1,'Movimiento 3', 0.00, 3.00); 
 INSERT INTO TMPSALDOS  VALUES (4,TO_DATE ('04/05/2020', 'DD/MM/RRRR'),1,'Movimiento 4', 42.00, 0.00); 
 INSERT INTO TMPSALDOS  VALUES (5,TO_DATE ('05/05/2020', 'DD/MM/RRRR'),1,'Movimiento 5', 4.00, 0.00); 
 INSERT INTO TMPSALDOS  VALUES (6,TO_DATE ('06/05/2020', 'DD/MM/RRRR'),1,'Movimiento 6', 242.00, 0.00); 
 INSERT INTO TMPSALDOS  VALUES (7,TO_DATE ('07/05/2020', 'DD/MM/RRRR'),1,'Movimiento 7', 4241.00, 0.00); 
 INSERT INTO TMPSALDOS  VALUES (8,TO_DATE ('08/05/2020', 'DD/MM/RRRR'),1,'Movimiento 8', 0.00, 252.00); 
 INSERT INTO TMPSALDOS  VALUES (9,TO_DATE ('09/05/2020', 'DD/MM/RRRR'),1,'Movimiento 9', 0.00, 43.00); 
 INSERT INTO TMPSALDOS  VALUES (10,TO_DATE ('10/05/2020', 'DD/MM/RRRR'),1,'Movimiento 10', 0.00, 355.00); 
 INSERT INTO TMPSALDOS  VALUES (11,TO_DATE ('11/05/2020', 'DD/MM/RRRR'),1,'Movimiento 11', 0.00, 53532.00); 
 INSERT INTO TMPSALDOS  VALUES (12,TO_DATE ('12/05/2020', 'DD/MM/RRRR'),1,'Movimiento 12', 0.00, 341.00); 
 INSERT INTO TMPSALDOS  VALUES (13,TO_DATE ('13/05/2020', 'DD/MM/RRRR'),1,'Movimiento 13', 124.00, 0.00); 
 INSERT INTO TMPSALDOS  VALUES (14,TO_DATE ('14/05/2020', 'DD/MM/RRRR'),1,'Movimiento 14', 12424.00, 0.00); 
 INSERT INTO TMPSALDOS  VALUES (15,TO_DATE ('15/05/2020', 'DD/MM/RRRR'),1,'Movimiento 15', 4241.00, 0.00); 
 INSERT INTO TMPSALDOS  VALUES (16,TO_DATE ('16/05/2020', 'DD/MM/RRRR'),1,'Movimiento 16', 241.00, 0.00); 
 INSERT INTO TMPSALDOS  VALUES (17,TO_DATE ('17/05/2020', 'DD/MM/RRRR'),1,'Movimiento 17', 0.00, 4242.00); 
 INSERT INTO TMPSALDOS  VALUES (18,TO_DATE ('18/05/2020', 'DD/MM/RRRR'),1,'Movimiento 18', 0.00, 2424.00); 
 INSERT INTO TMPSALDOS  VALUES (19,TO_DATE ('19/05/2020', 'DD/MM/RRRR'),1,'Movimiento 19', 0.00, 424.00); 
 INSERT INTO TMPSALDOS  VALUES (20,TO_DATE ('20/05/2020', 'DD/MM/RRRR'),1,'Movimiento 20', 3424.00, 0.00); 
 INSERT INTO TMPSALDOS  VALUES (21,TO_DATE ('21/05/2020', 'DD/MM/RRRR'),2,'Movimiento 21', 11134.00, 0.00); 
 INSERT INTO TMPSALDOS  VALUES (22,TO_DATE ('01/05/2020', 'DD/MM/RRRR'),2,'Movimiento 22', 0.00, 2.00); 
 INSERT INTO TMPSALDOS  VALUES (23,TO_DATE ('02/05/2020', 'DD/MM/RRRR'),2,'Movimiento 23', 4.00, 0.00); 
 INSERT INTO TMPSALDOS  VALUES (24,TO_DATE ('03/05/2020', 'DD/MM/RRRR'),2,'Movimiento 24', 0.00, 3.00); 
 INSERT INTO TMPSALDOS  VALUES (25,TO_DATE ('04/05/2020', 'DD/MM/RRRR'),2,'Movimiento 25', 42.00, 0.00); 
 INSERT INTO TMPSALDOS  VALUES (26,TO_DATE ('05/05/2020', 'DD/MM/RRRR'),2,'Movimiento 26', 4.00, 0.00); 
 INSERT INTO TMPSALDOS  VALUES (27,TO_DATE ('06/05/2020', 'DD/MM/RRRR'),2,'Movimiento 27', 242.00, 0.00); 
 INSERT INTO TMPSALDOS  VALUES (28,TO_DATE ('07/05/2020', 'DD/MM/RRRR'),2,'Movimiento 28', 4241.00, 0.00); 
 INSERT INTO TMPSALDOS  VALUES (29,TO_DATE ('08/05/2020', 'DD/MM/RRRR'),2,'Movimiento 29', 0.00, 252.00); 
 INSERT INTO TMPSALDOS  VALUES (30,TO_DATE ('09/05/2020', 'DD/MM/RRRR'),2,'Movimiento 30', 0.00, 43.00); 
 INSERT INTO TMPSALDOS  VALUES (31,TO_DATE ('10/05/2020', 'DD/MM/RRRR'),2,'Movimiento 31', 0.00, 355.00); 
 INSERT INTO TMPSALDOS  VALUES (32,TO_DATE ('11/05/2020', 'DD/MM/RRRR'),2,'Movimiento 32', 0.00, 53532.00); 
 INSERT INTO TMPSALDOS  VALUES (33,TO_DATE ('12/05/2020', 'DD/MM/RRRR'),2,'Movimiento 33', 0.00, 341.00); 
 INSERT INTO TMPSALDOS  VALUES (34,TO_DATE ('13/05/2020', 'DD/MM/RRRR'),2,'Movimiento 34', 124.00, 0.00); 
 INSERT INTO TMPSALDOS  VALUES (35,TO_DATE ('14/05/2020', 'DD/MM/RRRR'),2,'Movimiento 35', 12424.00, 0.00); 
 INSERT INTO TMPSALDOS  VALUES (36,TO_DATE ('15/05/2020', 'DD/MM/RRRR'),2,'Movimiento 36', 4241.00, 0.00); 
 INSERT INTO TMPSALDOS  VALUES (37,TO_DATE ('16/05/2020', 'DD/MM/RRRR'),2,'Movimiento 37', 241.00, 0.00); 
 INSERT INTO TMPSALDOS  VALUES (38,TO_DATE ('17/05/2020', 'DD/MM/RRRR'),2,'Movimiento 38', 0.00, 4242.00); 
 INSERT INTO TMPSALDOS  VALUES (39,TO_DATE ('18/05/2020', 'DD/MM/RRRR'),2,'Movimiento 39', 0.00, 2424.00); 
 INSERT INTO TMPSALDOS  VALUES (40,TO_DATE ('19/05/2020', 'DD/MM/RRRR'),2,'Movimiento 40', 0.00, 424.00); 
 INSERT INTO TMPSALDOS  VALUES (41,TO_DATE ('20/05/2020', 'DD/MM/RRRR'),2,'Movimiento 41', 3424.00, 0.00); 
 INSERT INTO TMPSALDOS  VALUES (42,TO_DATE ('21/05/2020', 'DD/MM/RRRR'),2,'Movimiento 42', 11134.00, 0.00); 

 COMMIT;
 end;
/

SELECT *
FROM TMPSALDOS;
/

CREATE OR REPLACE FUNCTION SALDO_MONEDA (PCOD_MONEDA_N IN NUMBER
) RETURN NUMBER IS
WRES NUMBER;
BEGIN
  CASE WHEN PCOD_MONEDA_N = 1 THEN 
     WRES := 200000000;
  ELSE 
     WRES := 100000;
  END CASE;   
  RETURN WRES;
END SALDO_MONEDA;

/

SELECT REG.NUM_CONSEC, REG.FEC_MOVIM, REG.COD_MONEDA_N,
    REG.DES_MOVIM, REG.MTO_CREDITO, REG.MTO_DEBITO,
    REG.NUM_FILGRUPO, REG.MTO_SALDO, REG.SAL_NETO,
    SUM (REG.SAL_NETO) OVER (PARTITION BY REG.COD_MONEDA_n order by reg.num_consec) as mto_salacum,
    MTO_SALDO - SUM (REG.SAL_NETO) OVER (PARTITION BY REG.COD_MONEDA_n order by reg.num_consec) AS MTO_SALACUMREAL
FROM (
    SELECT A.NUM_CONSEC, A.FEC_MOVIM, A.COD_MONEDA_N,
    A.DES_MOVIM, A.MTO_CREDITO, A.MTO_DEBITO,
    ROW_NUMBER()  OVER (PARTITION BY COD_MONEDA_N
                              ORDER BY NUM_CONSEC) AS NUM_FILGRUPO,
    SALDO_MONEDA (A.COD_MONEDA_n) AS MTO_SALDO,
    (CASE WHEN A.MTO_DEBITO > 0 THEN -1 ELSE 1 END) * (A.MTO_CREDITO + A.MTO_DEBITO) AS SAL_NETO
    FROM TMPSALDOS A
    ORDER BY A.NUM_CONSEC
) REG

/





